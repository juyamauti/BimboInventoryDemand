---
title: "BimboInventoryDemand"
author: "Juliana Yamauti"
date: "19/07/2020"
output: html_document
---

### Kaggle - Grupo Bimbo Inventory Demand
### Challenge: maximize sales and minimize returns of bakery goods
Dataset: https://www.kaggle.com/c/grupo-bimbo-inventory-demand

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
library(data.table)
library(dplyr)
library(caret)
library(ggplot2)
library(corrplot)
```

Loading "produto" dataset

```{r}
df_produto <- fread("producto_tabla.csv", header = TRUE, sep = ",", encoding = "UTF-8")
head(df_produto)
```

Loading "cliente" dataset

```{r}
df_cliente <- fread("cliente_tabla.csv", header = TRUE, sep = ",", encoding = "UTF-8")
head(df_cliente) #repeat data
```

Loading "town" dataset

```{r}
df_town <- fread("town_state.csv", header = TRUE, sep = ",", encoding = "UTF-8")
head(df_town)
```

Since the train dataset is too big (74180464 rows), I generated a 100.000 rows sample using sample_n function and saved in a new file:

```{r}
#reading the train sample file
df_sample <- fread("AmostraBimbo.csv", header = TRUE, sep = ",", encoding = "UTF-8")

#Removing column #1 with row number
df_sample$V1 <- NULL
df_sample <- as.data.frame(df_sample)

head(df_sample)
```

Train dataset summary and datatype:

```{r}
summary(df_sample)
```

```{r}
str(df_sample)
```

#### EDA (Exploratory Data Analysis using ggplot2)

Checking "Semana" distribution

```{r}
ggplot(data = df_sample) +
  geom_histogram(mapping = aes(x = Semana), binwidth = 0.5)
```

Checking "Agencia_ID" distribution

```{r}
ggplot(data = df_sample) +
  geom_histogram(mapping = aes(x = Agencia_ID), binwidth = 200)
```

Checking "Canal_ID" distribution

```{r}
ggplot(data = df_sample) +
  geom_histogram(mapping = aes(x = Canal_ID), binwidth = 0.5)
```

Checking for outliers

```{r}
ggplot(data = df_sample, mapping = aes(y = Demanda_uni_equil)) +
  geom_boxplot()

ggplot(data = df_sample, mapping = aes(y = Venta_uni_hoy)) +
  geom_boxplot()

ggplot(data = df_sample, mapping = aes(y = Venta_hoy)) +
  geom_boxplot()
```

Checking correlation between variables

```{r}
col_num <- sapply(df_sample, is.numeric)
data_cor <- cor(df_sample[,col_num])

corrplot(data_cor, method = 'color')
```

```{r}
ggplot(data = df_sample) +
  geom_point(mapping = aes(x = Agencia_ID, y = Demanda_uni_equil))

ggplot(data = df_sample) +
  geom_point(mapping = aes(x = Venta_uni_hoy, y = Demanda_uni_equil))

ggplot(data = df_sample) +
  geom_point(mapping = aes(x = Venta_hoy, y = Demanda_uni_equil))
```

##### Using dplyr to group/join data and get some insights

Top 10 sum of "Demanda_uni_equil" by State

```{r}
df_sample %>%
  inner_join(df_town, by = 'Agencia_ID') %>%
  select(State, Demanda_uni_equil) %>%
  group_by(State) %>%
  summarize(ave_Demanda = sum(Demanda_uni_equil)) %>%
  arrange(desc(ave_Demanda))
```

Top 10 sum of "Demanda_uni_equil" by NombreCliente

```{r}
df_sample %>%
  inner_join(df_cliente, by = 'Cliente_ID') %>%
  select(NombreCliente, Demanda_uni_equil) %>%
  group_by(NombreCliente) %>%
  summarize(ave_Demanda = sum(Demanda_uni_equil)) %>%
  arrange(desc(ave_Demanda))
```

Top 10 sum of "Demanda_uni_equil" by NombreProducto

```{r}
df_sample %>%
  inner_join(df_produto, by = 'Producto_ID') %>%
  select(NombreProducto, Demanda_uni_equil) %>%
  group_by(NombreProducto) %>%
  summarize(ave_Demanda = sum(Demanda_uni_equil)) %>%
  arrange(desc(ave_Demanda))
```

Most important variables for the model using varImp

```{r}
modelol_v1 <- train(Demanda_uni_equil ~ ., data = df_sample, method = "lm")
varImp(modelol_v1)
```

Normalizing train dataset

```{r}
dados_z <- scale(df_sample[,-11]) #nÃ£o normaliza a coluna target
df_sample <- as.data.frame(cbind(dados_z, df_sample$Demanda_uni_equil))
rm(dados_z)
colnames(df_sample)[11] <- "Demanda_uni_equil"
head(df_sample)
```

Separating data into train/test

Train dimension:
```{r}
linha <- sample(1:nrow(df_sample), 0.7 * nrow(df_sample))
df_train <- df_sample[linha,]
df_test <- df_sample[-linha,]

dim(df_train)
```

Test dimension:
```{r}
dim(df_test)
```

Creating the model and printing the summary

```{r}
modelo <- lm(Demanda_uni_equil ~ Venta_uni_hoy 
             + Venta_hoy
             + Dev_uni_proxima
             + Dev_proxima, data = df_train)

previsao2 <- predict(modelo, df_test)

summary(modelo)
```

Calculating the RMSLE

```{r}
predicted_value = abs(previsao2) 
actual_value = abs(df_test$Demanda_uni_equil)

SLE = (log(predicted_value + 1) - log(actual_value+ 1))^2

RMSLE = sqrt(mean(SLE))

Score = 1/(1+exp(RMSLE))

Score
```

